<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dashboard</title>
	<link rel="stylesheet" href="../css/dashboardStyle.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="../js/sessao.js"></script>
	<script src="../js/alerta.js"></script>
</head>

<!-- <body> -->
<body onload=" validarSessao(), exibirSalas(), atualizacaoPeriodica()">

	<div class="card_alerta" id="card_alerta">
		
	</div>

	<div class="navbar" id="navbar">
		<div class="container_sidebar">
			<span id="side-bar-deactive">X</span>
			<div class="logo">
				<img src="../assets/dashboard/logo.svg" alt="Logo HardwareLife">
				<h1>HardwareLife</h1>
			</div>
		</div>
		<div class="sidebar">
			<div class='perfil'>
				<div class="img_perfil"><img src="../assets/perfil/amazon.jfif" alt="profile"></div>
				<span id="nome_empresa"></span>
			</div>
			<div class="link_part">
				<span class="link">
					<img src="../assets/dashboard/icon_config.svg" alt="configurações">
					<a href="perfil/funcionario.html">Funcionários</a>
				</span>
				<span class="link">
					<img src="../assets/dashboard/relatorio.svg" alt="">
					<a id="suporte2">Fale Conosco</a>
				</span>
				<!-- <span class="link">
					<img src="../assets/dashboard/icon_dashboard.svg" alt="dashboard">
					<a href="../dashboard/dashboardNova.html">Dashboard</a>
				</span> -->
				<span class="link" onclick="limparSessao()">
					<img src="../assets/dashboard/icon_logout.svg" alt="logo">
					<a href="../loginCadastro.html">Sair</a>
				</span>

			</div>
		</div>
	</div>

	<div class="header">
		<div class="container">
			<div class="side-bar" id="side-bar-active">
				<i class="fa fa-align-justify"></i>
				<div class="logo" id="container">
					<img src="../assets/dashboard/logo.svg" alt="Logo HardwareLife">
					<h1>HardwareLife</h1>
				</div>
			</div>

			<div class="usuario_perfil">
				<h1>Olá, <span id="nome_usuario"> </span></h1>
			</div>
		</div>
	</div>

	<div class="div_desc" >
		<p>Aqui você poderá vizualizar todas as salas cadastradas:</p>
	</div>

	<div class="suporte" id="modalSuporte">
		<div class="suporte_title">
			<i id="suporte" class="fa fa-window-close"></i>
		</div>
		<iframe id="myFrame" width='100%' height='450'
		src='https://app.pipefy.com/public/form/2Kv8Bdqt?embedded=true'
		frameborder='0'
		></iframe>
	</div>

	<!-- tela inicial: sala - situação  -->
	<div class="dashboard">
		<div class="dashboard_titulo">
			<h3>SALA</h3>
			<h3>SITUAÇÃO</h3>
		</div>

		<div class="dash_lista" id="dash_lista">
			<!-- <div class="div_salas" onclick="chamar_salas()" id="div_salas"
				style="background-color: #b00202c0; border: 3px solid #b00202;">

				<button class="btn_salas" style="background-color: rgba(176, 2, 2, 0);">
					<img src="../assets/dashboard/door.svg" alt="Relatório">
					Sala 1
				</button>
				<span class="situacao">
					<p>Estado: Critico</p>
				</span>
			</div> -->
		</div>

	</div>

	<!-- visualização da sala selecionada -->
	<div class="div_desc_sala" >
		<p>Vizualizando Sala 5</p>
		<p>Estado: Critico</p>
	</div>

	<div class="dashboard_sala">

		<div class="separacao_superior">
			<div class="botao">
				<button onclick="voltar_sala()" class="btn_voltar" id="btn_voltar">
					<img src="../assets/dashboard/botao-voltar.png" alt="">
				</button>
			</div>
			<div class="medidas">
				<div class="tab_medidas">
					<div class="legend">
						<h4>Tabela de medidas Temperatura</h4>

						<table class="tabela">
							<thead>
								<tr class="linha">
									<th class="blueStrong">Crítico</th>
									<th class="blue">Emergência</th>
									<th class="ciano">Alerta</th>
									<th colspan="2" class="green">Ideal</th>
									<!-- <th class="green">Ideal</th> -->
									<th class="yellow">Alerta</th>
									<th class="orange">Emergência</th>
									<th class="red">Crítico</th>
								</tr>
							</thead>

							<tbody>
								<tr>
									<td class="blueStrong">18°C</td>
									<td class="blue">19,5°C</td>
									<td class="ciano">23,8°C</td>
									<td class="green">24°C</td>
									<td class="green">27°C</td>
									<td class="yellow">30°C</td>
									<td class="orange">34ºC</td>
									<td class="red">40ºC</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="legend">
						<h4>Tabela de medidas Umidade</h4>

						<table class="tabela">
							<thead>
								<tr class="linha">
									<th class=" blueStrong">Crítico</th>
									<th class="blue">Emergência</th>
									<th class="ciano">Alerta</th>
									<th colspan="2" class="green">Ideal</th>
									<!-- <th class="green">Ideal</th> -->
									<th class="yellow">Alerta</th>
									<th class="orange">Emergência</th>
									<th class="red">Crítico</th>
								</tr>
							</thead>

							<tbody>
								
								<tr>
									<td class="blueStrong">20%</td>
									<td class="blue">30%</td>
									<td class="ciano">40%</td>
									<td class="green">45%</td>
									<td class="green">55%</td>
									<td class="yellow">60%</td>
									<td class="orange">70%</td>
									<td class="red">80%</td>
								</tr>

							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- lista: rack - situacao -->
		<div class="div_rack">
			<div class="rack_titulo">
				<h3>Rack</h3>
				<h3>Situação</h3>
			</div>

			<div class="lista_rack" id="lista_rack">
				<!-- <div class="div_salas" onclick="chamar_rack()"
					style="background-color: #b00202c0; border: 3px solid #b00202;">

					<button class="btn_salas" style="background-color: #b0020200;">
						<img src="../assets/dashboard/rack-do-servidor.png" alt="Relatório">
						Rack 1
					</button>

					<span class="situacao">
						<p>Estado: Critico</p>
					</span>

				</div> -->
			</div>



			<!-- <div class="div_salas" style="background-color: rgb(176, 2, 2);">

				<button class="btn_salas" style="background-color: rgb(176, 2, 2);">
					<img src="scr/door.svg" alt="Relatório" style="width: 2%;">
					Rack 2
				</button>

				<p>Estado: Critico</p>
			</div> <br>

			<div class="div_salas" style="background-color: white;">

				<button class="btn_salas" style="background-color: white;">
					<img src="scr/door.svg" alt="Relatório" style="width: 2%;">
					Rack 3
				</button>

				<p>Estado: Normal</p>
			</div> <br> -->

		</div>
	</div>

	<!-- graficos sala - fim -->


	</div>

	<!-- visualização do rack selecionado -->
	<!-- <div class="div_desc_rack">
		<p>Vizualizando Rack 5</p>
		<p>Estado: Critico</p>
	</div> -->

	<div class="dashboard_rack">

		<div class="titulo_rack">
			<h3>Rack 1</h3>
			<!-- <div class="temp_umid">
				<h3>Temperatura</h3>
				<h3>Umidade</h3>
			</div> -->
			<button onclick="voltar_rack()" class="btn_voltar" id="btn_voltar">
				<img src="../assets/dashboard/botao-voltar.png" alt=""></button>
		</div>

		<div id="centroDiv" \>

			<!-- junção dois graficos -->
			<div class="graficos_direita">
				<!-- grafico mensal -->
				<div class="dashboard_chart_line">
					<canvas id="bar2"></canvas>
				</div>
				<!-- grafico tempo real -->
				<!-- grafico mensal -->
				<!-- <div class="dashboard_chart_line">
					<canvas id="bar2"></canvas>
				</div> -->

				<!-- grafico semanal -->
				<div class="dashboard_chart_line">
					<canvas id="bar3"></canvas>
				</div>
			</div>

			<!-- junção alerta, status sensores, grafico -->
			<div class="rack_esquerda">

				<div class="alerta_situacao">
					<!-- alerta -->
					<div class="alertas">
						<div class="alerta_rack">
							<img src="../assets/dashboard/triangle-alerta.svg" alt="" style="width: 40px;">
							<p>Temperatura muito acima do esperado</p>
						</div>
						<div class="alerta_umidade">
							<img src="../assets/dashboard/triangle-alerta.svg" alt="" style="width: 40px;">
							<p>Umidade em estado de alerta</p>
							<!-- </div> -->

						</div>
					</div>


					<!-- status sensores -->
					<div class="dashboard2" id="paginated-racks">
						<div class="pagination">
							<h3>Visualização de cada sensor do rack</h3>
							<div class="racks">
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="ideal esfera"></div>
									<p>Temperatura</p>
								</div>
								<div class="sensor">
									<div class="esfera_umidade_ideal umidade"></div>
									<p>Umidade</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- <div class="grafico_chart_line"> -->
				<div class="dashboard_chart_line">
					<canvas id="myChart"></canvas>
				</div>

				<!-- <div class="dashboard_chart_line">
					<canvas id="bar3"></canvas>
				</div> -->
			</div>
		</div>


	</div>


</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>

<!-- SCRIPT ANIMAÇÃO DA BARRA LATERAL -->
<script>
	nome_usuario.innerHTML = sessionStorage.NOME_USUARIO;
	nome_empresa.innerHTML = sessionStorage.NOME_EMPRESA;
	var abrirSuporte = document.getElementById("suporte2");
	var fecharSuporte = document.getElementById("suporte");

	abrirSuporte.addEventListener('click', () =>{
		modalSuporte.style.display = `block`
	})

	fecharSuporte.addEventListener('click', () => {
		modalSuporte.style.display = `none`
	})

	var activeSideBar = document.getElementById("side-bar-active");
	var deactiveSideBar = document.getElementById("side-bar-deactive");

	activeSideBar.addEventListener("click", function () {
		navbar.style.display = "flex";
		// navbar.style.animation = "abrir 1s";
		container.style.visibility = "hidden";

	})

	deactiveSideBar.addEventListener("click", function () {
		navbar.style.display = "none";
		// navbar.style.animation = "fechar 1s";
		container.style.visibility = "visible";
	});

	function exibirSalas() {

		var listaSalaUsada = [];
		JSON.parse(sessionStorage.SALAS).forEach((item, i) => {
			var dashLista = document.getElementById("dash_lista");
			
			if (!listaSalaUsada.includes(item.idSala)) {
				dashLista.innerHTML += `
				<div class="div_salas" onclick="chamar_salas(this)" id="div_salas" style="background-color: #008000;" valueSala="${item.idSala}">

					<button class="btn_salas" >
					<img src="../assets/dashboard/door.svg" alt="Relatório" ">
					Sala ${item.numeroSala}
					</button>
					<span class="situacao">
						<p>Estado: Critico</p>
					</span>

				</div>
			`
			listaSalaUsada.push(item.idSala)
			}
			// obterDadosGrafico(item.idRack)
		});

		// var elemento = document.querySelector("[valueSala='1']")
		// console.log(elemento.style)
	}
</script>

<script>
	var divDesc = document.querySelector('.div_desc');
	var divDashboard = document.querySelector('.dashboard');
	var divDescSala = document.querySelector('.div_desc_sala');
	var dashboardSala = document.querySelector('.dashboard_sala');
	var dashboardRack = document.querySelector('.dashboard_rack');


	// Crir json com as salas como no codigo a cima; Colocar o codigo da rack aqui dentro
	// JSON.parse(sessionStorage.SALAS).forEach(item)
	function chamar_salas(sala) {
		lista_rack.innerHTML = "";
		JSON.parse(sessionStorage.SALAS).forEach(salas=>{
			var idSala = sala.getAttribute("valueSala");

			if(salas.idSala == idSala){
				lista_rack.innerHTML += `
				<div class="div_salas" id="div_salas" onclick="chamar_rack(this)" valueRack="${salas.idRack}" style="background-color: #008000;">

					<button class="btn_salas" style="opacity: #b0020200;">
						<img src="../assets/dashboard/rack-do-servidor.png" alt="Relatório">
						Rack ${salas.numeroRack}
					</button>

					<span class="situacao">
						<p>Estado: Critico</p>
					</span>

				</div>
				`
				// obterDadosGrafico(salas.idRack)
			}

		})
		
		
		divDesc.style.display = 'none';
		divDashboard.style.display = 'none';
		divDescSala.style.display = 'flex';
		dashboardSala.style.display = 'flex';
	}

	function voltar_sala() {
		divDesc.style.display = 'flex';
		divDashboard.style.display = 'flex';
		divDescSala.style.display = 'none';
		dashboardSala.style.display = 'none';
	}

	function chamar_rack(rack) {
		var idRack = rack.getAttribute("valueRack");
		console.log(idRack)
		obterDadosGrafico(idRack)
		obterGraficoMensal(idRack)
		obterGraficoSemanal(idRack)
		divDescSala.style.display = 'none';
		dashboardSala.style.display = 'none';
		dashboardRack.style.display = 'flex';
	}

	function voltar_rack() {
		divDescSala.style.display = 'flex';
		dashboardSala.style.display = 'flex';
		dashboardRack.style.display = 'none';
	}

	// SCRIPT DOS GRÁFICOS

	var proximaAtualizacao;
	var atualizacaoSimulada

	function obterGraficoMensal(idRack){

		var resultado;
		myBar.data.labels = []
		myBar.data.datasets[0].data = []
		myBar.data.datasets[1].data = []

		fetch(`/medidas/media-mensal/${idRack}`, {
			method: "GET",
			headers: {
				"Content-Type": "application/json"
			},
			cache: 'no-store'
		}).then(data => {
			if(data.ok){
				data.json().then(json => {
					resultado = json
					console.log(resultado)
					resultado.reverse()
					for(var i = 0; i < resultado.length; i++){
						myBar.data.labels.push(resultado[i].mes)
						myBar.data.datasets[0].data.push(resultado[i].temperaturaMedia)
						myBar.data.datasets[1].data.push(resultado[i].umidadeMedia)
					}
					myBar.update()
				})
			}
		})
	}

	function obterGraficoSemanal(idRack){

		var resultado;
		myLine2.data.labels = []
		myLine2.data.datasets[0].data = []
		myLine2.data.datasets[1].data = []

		fetch(`/medidas/media-semanal/${idRack}`, {
			method: "GET",
			headers: {
				"Content-Type": "application/json"
			},
			cache: 'no-store'
		}).then(data => {
			if(data.ok){
				data.json().then(json => {
					resultado = json
					console.log(resultado)
					resultado.reverse()
					for(var i = 0; i < resultado.length; i++){
						myLine2.data.labels.push(resultado[i].momento_grafico)
						myLine2.data.datasets[0].data.push(resultado[i].temperaturaMedia)
						myLine2.data.datasets[1].data.push(resultado[i].umidadeMedia)
					}
					myLine2.update()
				})
			}
		})
		}

	function obterDadosGrafico(idRack) {
		
		myLine.data.labels = []
		myLine.data.datasets[0].data = []
		myLine.data.datasets[1].data = []

		if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }
		if(atualizacaoSimulada != undefined){
			clearTimeout(atualizacaoSimulada)
		}


		fetch(`/medidas/ultimas/${idRack}`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (resposta) {
					console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
					resposta.reverse();

					plotarGrafico(resposta, idRack);

				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});
		}

	function plotarGrafico(resposta, idRack) {

			console.log('----------------------------------------------')
			console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
			console.log(resposta)
			
			// Inserindo valores recebidos em estrutura para plotar o gráfico
			for (i = 0; i < resposta.length; i++) {
				var registro = resposta[i];
				console.log(registro)
				myLine.data.labels.push(registro.momento_grafico);
				myLine.data.datasets[0].data.push(registro.temperatura);
				myLine.data.datasets[1].data.push(registro.umidade);
			}

			myLine.update()


			setTimeout(() => atualizarGrafico(idRack, myLine), 2000);
}

	function atualizarGrafico(idRack, myLine) {
	 fetch(`/medidas/tempo-real/${idRack}`, { cache: 'no-store' }).then(function (response) {
		if (response.ok) {
			response.json().then(function (novoRegistro) {

				console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
				console.log(`Dados atuais do gráfico:`);

				if (novoRegistro[0].momento_grafico == myLine.data.labels[myLine.data.labels.length - 1]) {
					console.log("---------------------------------------------------------------")
					console.log("Como não há dados novos para captura, o gráfico não atualizará.")
					console.log("Horário do novo dado capturado:")
					console.log(novoRegistro[0].momento_grafico)
				} else {

					temperaturaSensor = novoRegistro[1].temperatura;
					umidadeSensor = novoRegistro[0].umidade;

					
					myLine.data.labels.shift();
					myLine.data.labels.push(novoRegistro[0].momento_grafico);

					myLine.data.datasets[0].data.shift();
					myLine.data.datasets[0].data.push(temperaturaSensor);

					myLine.data.datasets[1].data.shift();
					myLine.data.datasets[1].data.push( );

					myLine.update();
					// console.log(temperaturaSensor, umidadeSensor)
					// console.log("Sensor 2", temperaturaSensor2)
					// console.log("Sensor 3", temperaturaSensor3)
					// console.log("Sensor 4", temperaturaSensor4)
					// console.log("Sensor 5", temperaturaSensor5)
					// console.log("Sensor 6", temperaturaSensor6)

					// obterdados(temperaturaSensor, umidadeSensor, idRack)
					// alertar(temperaturaSensor, umidadeSensor, idRack);
				}

				// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
				proximaAtualizacao = setTimeout(() => atualizarGrafico(idRack, myLine), 2000);
			});
		} else {
			console.error('Nenhum dado encontrado ou erro na API');
			// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
			proximaAtualizacao = setTimeout(() => atualizarGrafico(idRack, myLine), 2000);
		}
	})
		.catch(function (error) {
			console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
		});

	}

	const ctx = document.getElementById("myChart");
	const bar2 = document.getElementById("bar2");
	const bar3 = document.getElementById("bar3");

	var myLine = new Chart(ctx, {
		type: 'line',
		data: {
			labels: [],
			datasets: [
				{
					data: [],
					label: "Temperatura",
					fontSize: 15,
					borderColor: "#ffa500",
					fill: false,
					fontSize: 160
				},
				{
					data: [],
					label: "Umidade",
					borderColor: "#2eb2ff",
					fill: false
				}]
		},
		options: {
			maintainAspectRatio: false,
			scales: {
				x: {
					ticks: {
						font: {
							size: 14,
						}
					}
				},
				y: {
					ticks: {
						font: {
							size: 14
						}
					}
				}
			},
			plugins: {
				title: {
					display: true,
					text: 'Medições em tempo real',
					color: "black",
					font: {
						size: 20
					}
				}
			}
		}
	});

	var myBar = new Chart(bar2, {
		type: 'bar',
		data: {
			labels: [],
			datasets: [
				{
					data: [],
					label: "Temperatura média",
					backgroundColor: "#ffa500",
					fill: false
				},
				{
					data: [],
					label: "Umidade Média",
					backgroundColor: "#2eb2ff",
					fill: false
				}
			]
		},
		options: {
			maintainAspectRatio: false,
			scales: {
				x: {
					ticks: {
						font: {
							size: 14,
						}
					}
				},
				y: {
					min: 18,
					max: 80,
					ticks: {
						font: {
							size: 14
						}
					}
				}
			},
			plugins: {
				title: {
					display: true,
					text: 'Média Mensal',
					color: "black",
					font: {
						size: 20
					}
				}
			}
		}
	});

	var myLine2 = new Chart(bar3, {
		type: 'line',
		data: {
			labels: [],
			datasets: [
				{
					data: [],
					label: "Temperatura",
					borderColor: "#ffa500",
					backgroundColor: "#ffa500",
					fill: true
				},
				{
					data: [],
					label: "Umidade",
					borderColor: "#2eb2ff",
					backgroundColor: "#2eb2ff",
					fill: true
				}]
		},
		options: {
			maintainAspectRatio: false,
			scales: {
				x: {
					ticks: {
						font: {
							size: 14,
						}
					}
				},
				y: {
					ticks: {
						font: {
							size: 14
						}
					}
				}
			},
			plugins: {
				title: {
					display: true,
					text: 'Média Semanal',
					color: "black",
					font: {
						size: 20
					}
				}
			}
		}
	});

</script>